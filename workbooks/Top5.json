{
    "version": "Notebook/1.0",
    "items": [
      {
        "type": 1,
        "content": {
          "json": "## High Ports"
        },
        "customWidth": "10",
        "name": "text - 0",
        "styleSettings": {
          "margin": "5"
        }
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "Resources\r\n| where type =~ 'microsoft.network/networksecuritygroups'\r\n| extend rules = properties.securityRules\r\n| mv-expand rules\r\n| project nsgName = name,\r\n          ruleName = tostring(rules.name),\r\n          access = tostring(rules.properties.access),\r\n          direction = tostring(rules.properties.direction),\r\n          sourcePortRange = tostring(rules.properties.sourcePortRange),\r\n          destinationPortRange = tostring(rules.properties.destinationPortRange),\r\n          protocol = tostring(rules.properties.protocol)\r\n| where access == 'Allow'\r\n  and destinationPortRange in ('23', '137', '138', '139', '3389', '5900')\r\n| order by nsgName asc, ruleName asc\r\n| order by ['ruleName'] asc",
          "size": 1,
          "queryType": 1,
          "resourceType": "microsoft.resourcegraph/resources",
          "crossComponentResources": [
            "value::all"
          ],
          "visualization": "table",
          "gridSettings": {
            "labelSettings": [
              {
                "columnId": "nsgName",
                "label": "NSG Name"
              },
              {
                "columnId": "ruleName",
                "label": "Rule Name"
              },
              {
                "columnId": "access",
                "label": "Access "
              },
              {
                "columnId": "direction",
                "label": "Direction"
              },
              {
                "columnId": "sourcePortRange",
                "label": "Source Port"
              },
              {
                "columnId": "destinationPortRange",
                "label": "Destination Port"
              }
            ]
          }
        },
        "name": "query - 1"
      },
      {
        "type": 1,
        "content": {
          "json": "## Key Vault Public URL "
        },
        "customWidth": "15",
        "name": "text - 2",
        "styleSettings": {
          "margin": "5"
        }
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "resources\r\n| where type =~ \"microsoft.keyvault/vaults\"\r\n| extend publicAccess = tostring(properties.networkAcls.defaultAction)\r\n| where publicAccess =~ 'Allow'\r\n| summarize count_ = count() by type\r\n| extend count_ = iff(count_ == 0, 0, count_)\r\n| union (datatable(type:string, count_:long) [\"microsoft.keyvault/vaults\", 0])\r\n| summarize total_count = max(count_) by type",
          "size": 3,
          "queryType": 1,
          "resourceType": "microsoft.resourcegraph/resources",
          "crossComponentResources": [
            "value::all"
          ],
          "visualization": "tiles",
          "tileSettings": {
            "titleContent": {},
            "leftContent": {
              "columnMatch": "total_count",
              "formatter": 12,
              "formatOptions": {
                "palette": "auto"
              }
            },
            "showBorder": false
          }
        },
        "name": "query - 6"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "Resources\r\n| where type =~ 'Microsoft.KeyVault/vaults'\r\n| project name, resourceGroup, location, id, type, subscriptionId, tags, properties\r\n| extend typeDisplayName = case(type =~ 'microsoft.keyvault/vaults', 'Key vault', type)\r\n| extend locationDisplayName = case(\r\n    location =~ 'usgovvirginia', 'USGov Virginia',\r\n    location =~ 'global', 'Global',\r\n    location =~ 'usdod', 'USDoD',\r\n    location =~ 'usgov', 'USGov',\r\n    location =~ 'usgovarizona', 'USGov Arizona',\r\n    location =~ 'usdodcentral', 'USDoD Central',\r\n    location =~ 'usdodeast', 'USDoD East',\r\n    location =~ 'usgovtexas', 'USGov Texas',\r\n    location\r\n)\r\n| extend va_emass_id = tostring(tags['va_emass_id'])\r\n| extend keyVaultUrl = strcat('https://', name, '.vault.azure.net')\r\n| project name, resourceGroup, locationDisplayName, typeDisplayName, va_emass_id, id, subscriptionId, tags, keyVaultUrl\r\n| order by tostring(name) asc",
          "size": 1,
          "title": "$",
          "queryType": 1,
          "resourceType": "microsoft.resources/tenants",
          "crossComponentResources": [
            "value::tenant"
          ],
          "visualization": "table",
          "gridSettings": {
            "formatters": [
              {
                "columnMatch": "va_emass_id",
                "formatter": 4,
                "formatOptions": {
                  "palette": "blue"
                }
              },
              {
                "columnMatch": "subscriptionId",
                "formatter": 11
              }
            ],
            "labelSettings": [
              {
                "columnId": "va_emass_id",
                "label": "EMASS ID"
              }
            ]
          }
        },
        "name": "query - 3"
      },
      {
        "type": 1,
        "content": {
          "json": "## Storage Account w/ Public URL"
        },
        "customWidth": "25",
        "name": "text - 5",
        "styleSettings": {
          "margin": "5"
        }
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "Resources\r\n| where type =~ 'microsoft.storage/storageaccounts'\r\n| extend publicAccess = tostring(properties.networkAcls.defaultAction)\r\n| where publicAccess =~ 'Allow'\r\n| summarize count()",
          "size": 3,
          "queryType": 1,
          "resourceType": "microsoft.resourcegraph/resources",
          "crossComponentResources": [
            "value::all"
          ],
          "visualization": "tiles",
          "tileSettings": {
            "titleContent": {},
            "leftContent": {
              "columnMatch": "count_",
              "formatter": 12,
              "formatOptions": {
                "palette": "auto"
              }
            },
            "showBorder": false,
            "sortCriteriaField": "count_"
          }
        },
        "name": "query - 8"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "resources\r\n| where type == \"microsoft.storage/storageaccounts\"\r\n| project name, resourceGroup, location, id, type, subscriptionId, tags, properties\r\n| project name,publicNetworkAccessstatus = d.publicNetworkAccess, networkrules = d.networkAcls.virtualNetworkRules, defaultaction = d.networkAcls.defaultAction\r\n| where defaultaction == \"Allow\" or (networkrules != \"[]\" and defaultaction == \"Deny\")\r\n| extend va_emass_id = tostring(tags['va_emass_id'])\r\n| project name, resourceGroup, locationDisplayName, typeDisplayName, va_emass_id, id, subscriptionId, tags, keyVaultUrl\r\n| order by tostring(name) asc",
          "size": 2,
          "queryType": 1,
          "resourceType": "microsoft.resourcegraph/resources",
          "crossComponentResources": [
            "value::all"
          ],
          "visualization": "table"
        },
        "name": "query - 6"
      },
      {
        "type": 3,
        "content": {
          "version": "KqlItem/1.0",
          "query": "resources \r\n| where type == 'microsoft.storage/storageaccounts'\r\n| extend publicNetworkAccess = tostring(coalesce(properties.publicNetworkAccess, 'NULL'))\r\n| project storageAccountName = name, type, location, resourceGroup, va_emass_id, subscriptionId, publicNetworkAccess\r\n| summarize count() by storageAccountName, publicNetworkAccess",
          "size": 0,
          "queryType": 1,
          "resourceType": "microsoft.resourcegraph/resources",
          "crossComponentResources": [
            "value::all"
          ],
          "visualization": "table"
        },
        "name": "query - 7"
      }
    ],
    "fallbackResourceIds": [
      "Azure Monitor"
    ],
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
  }